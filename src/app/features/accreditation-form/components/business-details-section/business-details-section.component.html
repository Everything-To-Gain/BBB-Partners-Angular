<div [formGroup]="form()" class="space-y-4 sm:space-y-6">
  <div hlmCard>
    <div hlmCardHeader>
      <div hlmCardTitle class="text-lg sm:text-xl text-primary">Business Details</div>
      <div hlmCardDescription>
        Tell us more about your business operations and legal information.
      </div>
    </div>
    <div hlmCardContent class="space-y-3 sm:space-y-4">
      <hlm-form-field>
        <label hlmLabel>Business Description *</label>
        <textarea
          hlmInput
          placeholder="We provide residential and commercial roofing services including installations, repairs, and inspections."
          class="min-h-[100px]"
          formControlName="businessDescription"
        ></textarea>
        <hlm-error>Business description is required</hlm-error>
      </hlm-form-field>
      <hlm-form-field class="mt-4">
        <label hlmLabel>Business Service Area *</label>
        <textarea
          hlmInput
          placeholder="City, County, State"
          class="min-h-[100px]"
          formControlName="businessServiceArea"
        ></textarea>
        <hlm-error>Business service area is required</hlm-error>
        <hlm-hint class="mt-2 italic text-xs"
          >Please list all service areas for your business, specifying county, city, and state for
          each location.</hlm-hint
        >
      </hlm-form-field>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <hlm-form-field>
          <label hlmLabel>EIN (Employer Identification Number)</label>
          <input hlmInput placeholder="12-3456789" formControlName="ein" />
        </hlm-form-field>
        <div>
          <label hlmLabel class="mb-2">Type of Business *</label>
          <brn-popover
            [state]="state()"
            (stateChanged)="stateChanged($event)"
            sideOffset="5"
            class="w-full"
          >
            <button
              #businessTypeTrigger
              type="button"
              [class]="
                'w-full justify-between font-normal text-sm bg-background/50 border-border/60 focus:border-primary/50 focus:ring-primary/20  transition-all duration-200 inline-flex items-center px-3 py-2' +
                (form().get('businessType')?.invalid && form().get('businessType')?.touched
                  ? ' !border-destructive !border-1'
                  : '')
              "
              id="edit-profile"
              variant="outline"
              brnPopoverTrigger
              (click)="state.set('open')"
              hlmBtn
            >
              {{ currentTob() ? currentTob()?.name : 'Select Type of Business...' }}
              <ng-icon hlm size="sm" name="lucideChevronsUpDown" class="opacity-50" />
            </button>
            <hlm-command
              *brnPopoverContent="let ctx"
              hlmPopoverContent
              class="p-0 [&_button:hover]:!text-black"
              [style.width.px]="getBusinessTypeTriggerWidth()"
            >
              <hlm-command-search>
                <ng-icon hlm name="lucideSearch" />
                <input
                  placeholder="Search Type of Business..."
                  class="placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none disabled:cursor-not-allowed disabled:opacity-50"
                  (input)="commandSearch($event.target.value)"
                />
              </hlm-command-search>
              <div *brnCommandEmpty hlmCommandEmpty>No results found.</div>
              <hlm-command-list>
                <hlm-command-group>
                  @for (tob of tobItems(); track tob.cbbbId) {
                  <button
                    type="button"
                    hlm-command-item
                    [value]="tob.cbbbId"
                    (selected)="commandSelected(tob)"
                    class="hover:!text-black"
                    style="--hover-text-color: black"
                  >
                    <span>{{ tob.name }}</span>
                    <ng-icon
                      hlm
                      class="ml-auto"
                      [class.opacity-0]="currentTob()?.cbbbId !== tob.cbbbId"
                      name="lucideCheck"
                      hlmCommandIcon
                    />
                  </button>
                  }
                </hlm-command-group>
              </hlm-command-list>
            </hlm-command>
          </brn-popover>
          @if (form().get('businessType')?.invalid && form().get('businessType')?.touched) {
          <hlm-error class="mt-2">Type of business is required</hlm-error>
          }
        </div>
      </div>

      <div>
        <label hlmLabel class="mb-2">Secondary Business Types</label>
        <brn-popover
          [state]="secondaryState()"
          (stateChanged)="secondaryStateChanged($event)"
          sideOffset="5"
          class="w-full"
        >
          <button
            #secondaryBusinessTypeTrigger
            type="button"
            class="w-full justify-between font-normal text-sm bg-background/50 border-border/60 focus:border-primary/50 focus:ring-primary/20 transition-all duration-200 inline-flex items-center px-3 py-2 disabled:opacity-50 disabled:cursor-not-allowed"
            variant="outline"
            brnPopoverTrigger
            (click)="secondaryState.set('open')"
            hlmBtn
            [disabled]="!isBusinessTypeSelected()"
          >
            {{ getSecondaryTobsDisplayText() }}
            <ng-icon hlm size="sm" name="lucideChevronsUpDown" class="opacity-50" />
          </button>
          <hlm-command
            *brnPopoverContent="let ctx"
            hlmPopoverContent
            class="p-0 [&_button:hover]:!text-black"
            [style.width.px]="getSecondaryBusinessTypeTriggerWidth()"
          >
            <hlm-command-search>
              <ng-icon hlm name="lucideSearch" />
              <input
                placeholder="Search Type of Business..."
                class="placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none disabled:cursor-not-allowed disabled:opacity-50"
                [value]="secondarySearchValue()"
                (input)="secondaryCommandSearch($event.target.value)"
              />
            </hlm-command-search>
            <div *brnCommandEmpty hlmCommandEmpty>No results found.</div>
            <hlm-command-list>
              <hlm-command-group>
                @for (tob of getSecondaryTobItems(); track tob.cbbbId) {
                <button
                  type="button"
                  hlm-command-item
                  [value]="tob.cbbbId"
                  (selected)="secondaryCommandSelected(tob)"
                  class="hover:!text-black"
                  style="--hover-text-color: black"
                >
                  <span>{{ tob.name }}</span>
                  <ng-icon
                    hlm
                    class="ml-auto"
                    [class.opacity-0]="!isSecondaryTobSelected(tob.cbbbId)"
                    name="lucideCheck"
                    hlmCommandIcon
                  />
                </button>
                }
              </hlm-command-group>
            </hlm-command-list>
          </hlm-command>
        </brn-popover>

        @if (selectedSecondaryTobs().length > 0) {
        <div class="mt-3 flex flex-wrap gap-2">
          @for (tob of selectedSecondaryTobs(); track tob.cbbbId) {
          <span
            class="inline-flex items-center gap-1.5 rounded-full bg-primary/10 text-primary px-3 py-1.5 text-xs font-medium border border-primary/20"
          >
            <span>{{ tob.name }}</span>
            <button
              type="button"
              class="ml-0.5 inline-flex h-4 w-4 shrink-0 items-center justify-center rounded-full hover:bg-primary/20 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-1"
              (click)="removeSecondaryTob(tob)"
              [attr.aria-label]="'Remove ' + tob.name"
            >
              <ng-icon hlm name="lucideX" size="sm" />
            </button>
          </span>
          }
        </div>
        }
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <div>
          <label for="businessStartDate" hlmLabel class="px-1">Business Start Date *</label>
          <input
            hlmInput
            type="date"
            class="w-full mt-2"
            formControlName="businessStartDate"
            placeholder="Select a date"
          />

          @if ( form().get('businessStartDate')?.touched &&
          form().get('businessStartDate')?.errors?.['required'] ) {
          <hlm-error class="mt-1">Business start date is required</hlm-error>
          }
        </div>
        <hlm-form-field>
          <label hlmLabel>Business Entity Type *</label>
          <brn-select
            class="inline-block w-full"
            placeholder="Select entity types"
            formControlName="businessEntityType"
          >
            <hlm-select-trigger class="w-full">
              <hlm-select-value />
            </hlm-select-trigger>
            <hlm-select-content class="max-h-56">
              @for (entityType of entityTypes; track entityType) {
              <hlm-option value="{{ entityType }}">{{ entityType }}</hlm-option>
              }
            </hlm-select-content>
          </brn-select>
          <hlm-error>Business entity type is required</hlm-error>
        </hlm-form-field>
      </div>
    </div>
  </div>

  <div hlmCard>
    <div hlmCardHeader>
      <div hlmCardTitle class="text-lg sm:text-xl text-primary">Licenses & Certifications</div>
      <div hlmCardDescription>
        Please add your state business license or professional licenses below.
      </div>
    </div>
    <div hlmCardContent class="space-y-3 sm:space-y-4">
      <!-- Add License Button -->
      <div class="flex items-center justify-between">
        <label hlmLabel class="text-sm font-medium text-gray-700 dark:text-gray-300"
          >Licenses</label
        >
        <button
          type="button"
          hlmBtn
          variant="outline"
          size="sm"
          (click)="addLicense.emit()"
          class="flex items-center gap-2"
        >
          <ng-icon hlm name="lucidePlus" size="sm" />
          Add License
        </button>
      </div>

      <!-- Dynamic License Fields -->
      <div formArrayName="licenses" class="space-y-4">
        @for (license of licenses.controls; track $index) {
        <div class="border border-gray-200 rounded-lg p-4 space-y-3" [formGroupName]="$index">
          <div class="flex items-center justify-between">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">
              License {{ $index + 1 }}
            </h4>
            <button
              type="button"
              hlmBtn
              variant="outline"
              size="sm"
              (click)="removeLicense.emit($index)"
              class="text-destructive hover:text-destructive"
            >
              <ng-icon hlm name="lucideTrash2" size="sm" />
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
            <hlm-form-field>
              <label hlmLabel>Licensing Number *</label>
              <input hlmInput placeholder="CA-987654321" formControlName="licensingNumber" />
              <hlm-error>Licensing number is required</hlm-error>
            </hlm-form-field>
            <hlm-form-field>
              <label hlmLabel>Agency *</label>
              <input
                hlmInput
                placeholder="CSLB (Contractors State License Board)"
                formControlName="agency"
              />
              <hlm-error>Agency is required</hlm-error>
            </hlm-form-field>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
            <div>
              <label hlmLabel class="px-1">Date Issued *</label>
              <input
                hlmInput
                type="date"
                class="w-full mt-2"
                formControlName="dateIssued"
                placeholder="Select a date"
              />

              @if ( license.get('dateIssued')?.touched &&
              license.get('dateIssued')?.errors?.['required'] ) {
              <hlm-error class="mt-1">Date issued is required</hlm-error>
              }
            </div>
            <div>
              <label hlmLabel class="px-1">Expiration</label>
              <input
                hlmInput
                type="date"
                class="w-full mt-2"
                formControlName="expiration"
                placeholder="Select a date"
              />
            </div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>

  <div hlmCard>
    <div hlmCardHeader>
      <div hlmCardTitle class="text-lg sm:text-xl text-primary">Business Scale & Operations</div>
      <div hlmCardDescription>Information about your business size and customer base.</div>
    </div>
    <div hlmCardContent class="space-y-3 sm:space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <hlm-form-field>
          <label hlmLabel>Number of Full Time Employees *</label>
          <input
            type="number"
            hlmInput
            placeholder="10"
            formControlName="numberOfFullTimeEmployees"
          />
          <hlm-error>Number of full time employees is required</hlm-error>
        </hlm-form-field>

        <hlm-form-field>
          <label hlmLabel>Number of Part Time Employees</label>
          <input
            type="number"
            hlmInput
            placeholder="10"
            formControlName="numberOfPartTimeEmployees"
          />
        </hlm-form-field>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
        <hlm-form-field>
          <label hlmLabel>Gross Annual Revenue *</label>
          <input type="number" hlmInput placeholder="100000" formControlName="grossAnnualRevenue" />
          <hlm-error>Gross annual revenue is required</hlm-error>
        </hlm-form-field>
        <hlm-form-field>
          <label hlmLabel>Average Customers Per Year *</label>
          <brn-select
            class="inline-block w-full"
            placeholder="Select customer range"
            formControlName="avgCustomersPerYear"
          >
            <hlm-select-trigger class="w-full">
              <hlm-select-value />
            </hlm-select-trigger>
            <hlm-select-content class="max-h-56">
              @for (range of ranges; track range) {
              <hlm-option value="{{ range }}">{{ range }}</hlm-option>
              }
            </hlm-select-content>
          </brn-select>
          <hlm-error>Average customers per year is required</hlm-error>
        </hlm-form-field>
      </div>
    </div>
  </div>

  <div hlmCard>
    <div hlmCardHeader>
      <div hlmCardTitle class="text-lg sm:text-xl text-primary">
        Additional Business Information
      </div>
      <div hlmCardDescription>
        Any additional details that would help us better understand your business.
      </div>
    </div>
    <div hlmCardContent class="space-y-3 sm:space-y-4">
      <hlm-form-field>
        <label hlmLabel>Additional Information</label>
        <textarea
          hlmInput
          class="min-h-[100px]"
          placeholder="type your additional information here"
          formControlName="additionalBusinessInformation"
        ></textarea>
        <hlm-hint class="mt-2 italic text-xs"
          >Examples: Has your business been purchased recently? Does your business require a
          competency license?</hlm-hint
        >
      </hlm-form-field>
    </div>
  </div>
</div>
